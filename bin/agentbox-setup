#!/usr/bin/env bash
set -euo pipefail

resolve_path() {
  python3 - "$1" <<'PY'
import os, sys
print(os.path.realpath(sys.argv[1]))
PY
}

SCRIPT_PATH="$(resolve_path "${BASH_SOURCE[0]}")"
REPO_ROOT="$(cd "$(dirname "${SCRIPT_PATH}")/.." && pwd)"
PROJECT_CONFIG_DIR="${PWD}/.agentbox"
PROJECT_CONFIG_FILE="${PROJECT_CONFIG_DIR}/config.toml"

if [[ ! -d "${REPO_ROOT}/toolkits" ]]; then
  echo "toolkits directory not found; aborting" >&2
  exit 1
fi

echo "Agentbox setup"
echo "This will write a TOML config to ${PROJECT_CONFIG_FILE}"
echo
echo "Available toolkits:"
TOOLKIT_NAMES=()
while IFS= read -r name; do
  TOOLKIT_NAMES+=("${name}")
done < <(cd "${REPO_ROOT}/toolkits" && ls *.list 2>/dev/null | sed 's/\.list$//' | sort)
if [[ ${#TOOLKIT_NAMES[@]} -eq 0 ]]; then
  echo " (none found)"
else
  for name in "${TOOLKIT_NAMES[@]}"; do
    printf " - %s\n" "${name}"
  done
fi
echo
read -r -p "Select toolkits (space-separated, leave empty for none): " -a SELECTED

mkdir -p "${PROJECT_CONFIG_DIR}"

selected_line='selected = []'
if [[ ${#SELECTED[@]} -gt 0 ]]; then
  entries=()
  for tk in "${SELECTED[@]}"; do
    [[ -z "${tk}" ]] && continue
    entries+=("\"${tk}\"")
  done
  if [[ ${#entries[@]} -gt 0 ]]; then
    selected_line='selected = ['
    for idx in "${!entries[@]}"; do
      if [[ ${idx} -gt 0 ]]; then
        selected_line+=", "
      fi
      selected_line+="${entries[${idx}]}"
    done
    selected_line+="]"
  fi
fi

cat > "${PROJECT_CONFIG_FILE}" <<EOF
# Agentbox configuration

[toolkits]
${selected_line}
# Example: selected = ["python", "c_cpp"]

[network]
# Defaults allow OpenAI/Anthropic API hosts; uncomment to customize.
# allow_hosts = ["api.github.com", "registry.npmjs.org"]
# block_hosts = ["chatgpt.com"] # optional removals from defaults
# allow_file = "extra-hosts.txt" # optional, relative to this file
EOF

echo "Wrote ${PROJECT_CONFIG_FILE}"
