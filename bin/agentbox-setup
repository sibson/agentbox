#!/usr/bin/env bash
set -euo pipefail

resolve_path() {
  python3 - "$1" <<'PY'
import os, sys
print(os.path.realpath(sys.argv[1]))
PY
}

SCRIPT_PATH="$(resolve_path "${BASH_SOURCE[0]}")"
REPO_ROOT="$(cd "$(dirname "${SCRIPT_PATH}")/.." && pwd)"
PROJECT_CONFIG="${PWD}/.agentbox"

if [[ ! -d "${REPO_ROOT}/toolkits" ]]; then
  echo "toolkits directory not found; aborting" >&2
  exit 1
fi

echo "Agentbox setup"
echo "This will write a TOML config to ${PROJECT_CONFIG}"
echo
echo "Available toolkits:"
TOOLKIT_NAMES=()
while IFS= read -r name; do
  TOOLKIT_NAMES+=("${name}")
done < <(cd "${REPO_ROOT}/toolkits" && ls *.list 2>/dev/null | sed 's/\.list$//' | sort)
if [[ ${#TOOLKIT_NAMES[@]} -eq 0 ]]; then
  echo " (none found)"
else
  for name in "${TOOLKIT_NAMES[@]}"; do
    printf " - %s\n" "${name}"
  done
fi
echo
read -r -p "Select toolkits (space-separated, leave empty for none): " -a SELECTED

{
  echo "# Agentbox configuration"
  echo ""
  echo "[toolkits]"
  if [[ ${#SELECTED[@]} -gt 0 ]]; then
    printf 'selected = ['
    first=1
    for tk in "${SELECTED[@]}"; do
      [[ -z "${tk}" ]] && continue
      if [[ ${first} -eq 1 ]]; then
        first=0
      else
        printf ', '
      fi
      printf '"%s"' "${tk}"
    done
    echo "]"
  else
    echo 'selected = []'
  fi
} > "${PROJECT_CONFIG}"

echo "Wrote ${PROJECT_CONFIG}"
