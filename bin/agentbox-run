#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

DEFAULT_BASE_IMAGE="debian:bookworm-slim"
VERBOSE="${AGENTBOX_VERBOSE:-0}"

TARGET_AGENT="${AGENTBOX_AGENT:-}"
BASE_IMAGE="${DEFAULT_BASE_IMAGE}"
BUILD_ONLY=0
PROMPT_VALUE=""
CUSTOM_CMD=()
HOST_CODEX_AUTH="${AGENTBOX_CODEX_AUTH:-${HOME}/.codex}"
HOST_CLAUDE_AUTH="${AGENTBOX_CLAUDE_AUTH:-${HOME}/.claude}"
VERBOSE="${AGENTBOX_VERBOSE:-0}"

usage() {
  cat <<'USAGE'
Usage: bin/agentbox-run [--base <image>] [--build-only] <agent> [-- <command>]

Minimal launcher: builds the image (if needed) and runs the agent with full network access.

Options:
  --base <image>    Override base image (default: debian:bookworm-slim)
  --build-only      Build the image and exit
  --prompt <text>   Run a one-off Codex exec with the given prompt (codex only)
  -h, --help        Show this help
USAGE
}

fatal() { echo "agentbox-run: $*" >&2; exit 1; }

while [[ $# -gt 0 ]]; do
  case "$1" in
    --base)
      [[ $# -ge 2 ]] || fatal "--base requires a value"
      BASE_IMAGE="$2"; shift 2;;
    --build-only)
      BUILD_ONLY=1; shift;;
    --prompt)
      [[ $# -ge 2 ]] || fatal "--prompt requires a value"
      PROMPT_VALUE="$2"; shift 2;;
    -h|--help)
      usage; exit 0;;
    --)
      shift; CUSTOM_CMD=("$@"); break;;
    -*)
      fatal "Unknown option '$1'";;
    *)
      if [[ -z "${TARGET_AGENT}" ]]; then
        TARGET_AGENT="$1"; shift
        CUSTOM_CMD=("$@"); break
      else
        CUSTOM_CMD+=("$1"); shift
      fi
      ;;
  esac
done

if [[ -z "${TARGET_AGENT}" ]]; then
  fatal "Missing agent argument"
fi

TAG="agentbox/${TARGET_AGENT}:$(echo "${BASE_IMAGE}" | tr '/:' '_')"

if [[ "${VERBOSE}" == "1" ]]; then
if [[ "${VERBOSE}" == "1" ]]; then
  echo "-> Building image ${TAG} (base: ${BASE_IMAGE})"
  docker build \
    --file "${REPO_ROOT}/docker/Dockerfile" \
    --build-arg "BASE_IMAGE=${BASE_IMAGE}" \
    --tag "${TAG}" \
    "${REPO_ROOT}"
else
  docker build \
    --quiet \
    --file "${REPO_ROOT}/docker/Dockerfile" \
    --build-arg "BASE_IMAGE=${BASE_IMAGE}" \
    --tag "${TAG}" \
    "${REPO_ROOT}" >/dev/null
fi
else
  docker build \
    --quiet \
    --file "${REPO_ROOT}/docker/Dockerfile" \
    --build-arg "BASE_IMAGE=${BASE_IMAGE}" \
    --tag "${TAG}" \
    "${REPO_ROOT}" >/dev/null
fi

if [[ "${BUILD_ONLY}" -eq 1 ]]; then
  echo "Build complete for ${TARGET_AGENT}"
  exit 0
fi

TTY_OPT=""
if [[ -t 0 && -t 1 ]]; then
  TTY_OPT="-t"
fi

RUN_CMD=()
if [[ -n "${PROMPT_VALUE}" && "${TARGET_AGENT}" == "codex" ]]; then
  RUN_CMD=("codex" "exec" "${PROMPT_VALUE}" "--json" "--skip-git-repo-check" "--dangerously-bypass-approvals-and-sandbox")
elif [[ ${#CUSTOM_CMD[@]} -gt 0 ]]; then
  RUN_CMD=("${CUSTOM_CMD[@]}")
else
  if [[ "${TARGET_AGENT}" == "codex" ]]; then
    RUN_CMD=("codex" "--dangerously-bypass-approvals-and-sandbox")
    if [[ -z "${TTY_OPT}" ]]; then
      RUN_CMD=("/bin/bash")
    fi
  elif [[ "${TARGET_AGENT}" == "claude" ]]; then
    RUN_CMD=("claude" "--dangerously-skip-permissions")
  else
    RUN_CMD=("/bin/bash")
  fi
fi

[[ "${VERBOSE}" == "1" ]] && echo "-> Launching sandbox for ${TARGET_AGENT}"
MOUNTS=("-v" "${PWD}":/workspace)
if [[ "${TARGET_AGENT}" == "codex" && -d "${HOST_CODEX_AUTH}" ]]; then
  MOUNTS+=("-v" "${HOST_CODEX_AUTH}:/home/agent/.codex")
fi
if [[ "${TARGET_AGENT}" == "claude" && -d "${HOST_CLAUDE_AUTH}" ]]; then
  MOUNTS+=("-v" "${HOST_CLAUDE_AUTH}:/home/agent/.claude")
fi

docker run \
  --rm \
  -i \
  ${TTY_OPT:+${TTY_OPT}} \
  --name "agentbox-${TARGET_AGENT}-$$" \
  --network bridge \
  --cap-drop ALL \
  --pids-limit 512 \
  --security-opt no-new-privileges \
  --workdir /workspace \
  "${MOUNTS[@]}" \
  "${TAG}" \
  "${RUN_CMD[@]}"
